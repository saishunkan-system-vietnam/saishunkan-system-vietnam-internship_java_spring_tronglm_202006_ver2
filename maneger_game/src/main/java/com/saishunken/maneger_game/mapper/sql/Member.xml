<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.saishunken.maneger_game.mapper.MapperMember">

	<insert id="insert" parameterType="Member">
		INSERT INTO member (name_member, nickname, id_team, cap_flg, del_flg, create_date, edit_date, scored) 
		VALUES (#{name_member}, #{nickname}, #{id_team}, #{cap_flg}, #{del_flg}, #{create_date}, #{edit_date}, #{scored});
	</insert>
	
	<select id="getAll" parameterType="Member"
		resultType="Member">
		SELECT * FROM member WHERE del_flg = 0
		<if test="name_member != null">
			AND (name_member LIKE '%${name_member}%' OR nickname LIKE '%${name_member}%')
		</if>
	</select>
	
	<select id="getTotalMember" parameterType="Member" resultType="BigInteger">
		SELECT Count(*) FROM member WHERE del_flg = 0
		<if test="name_member != null">
			AND (name_member LIKE '%${name_member}%' OR nickname LIKE '%${name_member}%')
		</if>
	</select>
	
	<select id="getByTeam" parameterType="Member" resultType="Member">
		SELECT * FROM member WHERE id_team = #{id_team} AND del_flg = 0
		<if test="name_member != null">
			AND (name_member LIKE '%${name_member}%' OR nickname LIKE '%${name_member}%')
		</if>
		LIMIT  #{maxPageItem} 
		OFFSET #{offset}
	</select>
	
	<select id="getTotalByTeam" parameterType="Member" resultType="BigInteger">
		SELECT Count(*) FROM member WHERE id_team = #{id_team} and del_flg = 0
		<if test="name_member != null">
			AND (name_member LIKE '%${name_member}%' OR nickname LIKE '%${name_member}%')
		</if>
	</select>
	
	<select id="getByIdTeam" parameterType="Member" resultType="Member">
		SELECT * FROM member WHERE id_team > 0 AND del_flg = 0
		<if test="name_member != null">
			AND (name_member LIKE '%${name_member}%' OR nickname LIKE '%${name_member}%')
		</if>
		LIMIT  #{maxPageItem} 
		OFFSET #{offset}
	</select>
	
	<select id="getTotalByIdTeam" parameterType="Member" resultType="BigInteger">
		SELECT Count(*) FROM member WHERE id_team > 0 and del_flg = 0
		<if test="name_member != null">
			AND (name_member LIKE '%${name_member}%' OR nickname LIKE '%${name_member}%')
		</if>
	</select>
	
	<select id="getByNotIdTeam" parameterType="Member" resultType="Member">
		SELECT * FROM member WHERE id_team = 0 AND del_flg = 0
		<if test="name_member != null">
			AND (name_member LIKE '%${name_member}%' OR nickname LIKE '%${name_member}%' )
		</if>
		LIMIT  #{maxPageItem} 
		OFFSET #{offset}
	</select>
	
	<select id="getTotalByNotIdTeam" parameterType="Member" resultType="BigInteger">
		SELECT Count(*) FROM member WHERE id_team = 0 and del_flg = 0
		<if test="name_member != null">
			AND (name_member LIKE '%${name_member}%' OR nickname LIKE '%${name_member}%')
		</if>
	</select>
	
	<select id="getById" parameterType="int"
		resultType="Member">
		SELECT * FROM member WHERE id = #{id} and del_flg = 0;
	</select>
	
	<select id="getTotalByNickName"	resultType="int">
		SELECT Count(*) FROM member WHERE nickname = #{nickname} AND nickname != ""
		<if test ="id != null">
			AND id != #{id}
		</if>
	</select>
	
	<update id="update" parameterType="Member">
		UPDATE member SET	
		<if test="name_member != null">
			name_member = #{name_member},
		</if>	
		<if test="nickname != null">
			nickname = #{nickname},
		</if>
		<if  test="del_flg != null">
			del_flg = #{del_flg},
		</if>
		<if test="id_team != null">
			id_team = #{id_team},
		</if>
		<if test="cap_flg != null">
			cap_flg = #{cap_flg},
		</if>
		<if test="scored != null">
			scored = #{scored},
		</if>
		edit_date = #{edit_date}
		WHERE id = #{id} 
	</update>

	<update id="updateCap" parameterType="Member">
		UPDATE member SET cap_flg = 0			
		WHERE id_team = #{id_team} AND cap_flg = 1
	</update>
	
	<select id="getMemberAndPointByTeam" parameterType="int" resultMap="poinAllMemberMap">
		SELECT 
		  m1.id as "m1_id",
		  m1.name_member as "m1_name_member",
		  m1.nickname as "m1_nickname",
		  m1.id_team as "m1_id_team",

		  p1.id as "p1_id",
	      p1.id_member as "p1_id_member",
	      p1.scored as "p1_scored"
		FROM member m1
		LEFT JOIN point_member_math p1 ON m1.id = p1.id_member
		WHERE m1.id_team = #{id_team};
	</select>
	
	<resultMap id="pointMemberResultMap" type="PointMemberMatch">
		 <id property="id" column="p1_id" />  
		 <result property="id_member" column="p1_id_member" />
		 <result property="scored" column="p1_scored" />
	</resultMap>
	
	<resultMap type="Member" id="poinAllMemberMap">
		 <id property="id" column="m1_id" />  
		 <result property="name_member" column="m1_name_member" />
		 <result property="nickname" column="m1_nickname" />
		 <result property="id_team" column="m1_id_team" />	
		 <collection property="listpoint" javaType="ArrayList" ofType="PointMemberMatch" resultMap="pointMemberResultMap"></collection>
	</resultMap>

</mapper>